#include <curl/curl.h>
#include <iostream>
#include "../libs/colormod.hpp"

// Estrutura para armazenar a resposta da requisição
struct Response
{
  std::string data;

  static size_t write(void* ptr, size_t size, size_t nmemb, Response* response)
  {
    size_t realsize = size * nmemb;
    response->data.append((char*)ptr, realsize);
    return realsize;
  }
};

int main(int argc, char* argv[])
{

  Color::ColorMod RedColor(Color::FG_RED);
  Color::ColorMod DefaultColor(Color::FG_DEFAULT);
  Color::ColorMod YellowColor(Color::FG_YELLOW);
  Color::ColorMod GreenColor(Color::FG_GREEN);
  Color::ColorMod LightGreenColor(Color::FG_LGREEN);
  Color::ColorMod LightYellowColor(Color::FG_LYELLOW);

  // Verificando se o número de argumentos passados é o esperado
  if (argc != 2)
  {
    return 1;
  }

  // Inicializando a biblioteca cURL
  curl_global_init(CURL_GLOBAL_ALL);

  // Criando um handle cURL
  CURL* curl = curl_easy_init();
  if (curl)
  {
    std::string url = argv[1];
    url += "'";

    // URL Passado
    std::cout << "\nTarget URL: " << url << '\n';

    // Definindo o URL de destino da requisição
    curl_easy_setopt(curl, CURLOPT_URL, url.c_str());

    // Definindo o método HTTP da requisição como GET
    std::cout << RedColor << "\nSCANNING...\n\n" << DefaultColor;
    curl_easy_setopt(curl, CURLOPT_HTTPGET, 1L);

    // Criando estrutura para armazenar as respostas
    Response response;

    // Definindo a função de callback para armazenar a resposta
    curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, Response::write);
    curl_easy_setopt(curl, CURLOPT_WRITEDATA, &response);

    // Enviando a requisição e obtenha a resposta
    CURLcode res = curl_easy_perform(curl);

    // Verificando se a requisição foi bem-sucedida
    if (res != CURLE_OK)
    {
      std::cerr << "curl_easy_perform() failed: " << curl_easy_strerror(res) << std::endl;
    } else {
      // Armazenando a resposta esperada
      std::string expectedResponse = "expected response";

      if(response.data != expectedResponse) {
        std::cout << GreenColor << "[+] Possible SQL Injection detected\n\n";
      } else {
        std::cout << YellowColor << "[-] No SQL Injection detected\n\n";
      }
    }

    // Limpando o handle cURL
    curl_easy_cleanup(curl);
  }

  // Finalizando a biblioteca cURL
  curl_global_cleanup();

  return 0;
}
