#include <iostream>
#include <unistd.h>
#include <thread>

// Definindo comando de compilação

const char* COMMANDS = R"(for file in ./modules/*.cpp; do
            g++ "$file" -o "${file%.cpp}.o" -lcurl
done)";

// Função para compilar os módulos presentes

void CompileModules() {

    std::thread t1([](){
        system(COMMANDS);
    });

    t1.join();
}

// Função main para renderizar o CompileModules() e executar o programa normalmente
int main(int argc, char* argv[]) {
    CompileModules();

    // Iniciando variáveis antes da função while para não gerar erros de transferencia de controle
    int opt;
    std::string module, url, command, requests, link, exec;

    // Lê os argumentos da linha de comando um por vez
    while ((opt = getopt(argc, argv, "M:U:")) != -1) {
        // Analisa a opção especificada pelo usuário
        switch (opt) {
        // Opção -M para argumentos de módulo
        case 'M':
            module = optarg;
            command = "./modules/" + module + ".o ";
            system(command.c_str());
            break;     
        // Opção -U para argumentos de URL
        case 'U':
            url = optarg;
            exec = command.c_str() + url;
            system(exec.c_str());
            break;
        // Opção de ajuda
        default:
            std::cout << "Use: " << argv[0] << " [-M <módulo>] [-U <URL>] \n";
            return 1;
        }
    }

    return 0;
}